# RV1106 -- 设备树的更新与内核烧录



**注意: **

​	**本项目主要基于群友已有的ubuntu22.04版本固件进行更新**

​	**尝试自己编译SDK, 但仅有buildroot版本成功, 暂时不符合需求**



参考资料:

[基于瑞芯微RV1109 Linux触摸屏GT911驱动调试心得-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1867378)

[SDK编译环境搭建 (flowus.cn)](https://sololinker.flowus.cn/sololinker/share/fb980ca3-f536-4dfe-b4cd-448a54a632cf)

**注意: 一定要用上面链接里的编译环境搭建来构建编译环境, 不然会出各种各样莫名其妙的问题!**



## 测试I2C设备基本属性

**关键工具: i2c-tool; 引脚分布原理图**

在本sololinker开发板上, 可以看到连接RGB屏幕的I2C总线为i2c-4



1. 插入屏幕后检测i2c设备

``` bash
i2cdetect -y 4
```

此命令代表遍历查看i2c-4总线上的所有地址, 并返回对应值

如果返回值显示UU, 则代表此地址的设备已经被驱动所挂载.

如果返回值直接显示了地址值, 则代表i2c总线上有这个设备, 但是没有被驱动挂载

如果设备树里面没有GT911设备节点, 那么扫描后, 会显示5d地址值

![img](E:/Typora_note/photos/160e65f5757ef835a01b37bd8880d57d.png)



2. 查看已有的i2c设备上的设备树节点

``` bash
ls /sys/devices/ff470000.i2c/i2c-4
```

注意: 这个地址可能会随着硬件的不同而改变, 但文件路径与架构都是一样的.

通过上面的指令, 我们可以看到目前设备树上挂载的节点有哪些, 会以地址的形式显示出来

![](E:/Typora_note/photos/QQ%E5%9B%BE%E7%89%8720240514165731.jpg)





## 设备树的更新 -- 加入GT911设备

1. 外设在SDK中的文件路径

``` path
sysdrv/kernel/drivers/input/touchscreen/gt9xx
```

2. 定位各个关键函数

对于一个设备来说, 最关键的就是

"挂载在什么节点上", "从设备树里面读取的参数是什么"



首先查找关键词 **compatible**, 通过这个关键词, 我们可以得知设备树的参数"compatible"该定义为什么值

![截图 2024-05-12 17-34-10](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-34-10.png)

同样的, 在下面的i2c_driver结构体里面, 也进行了probe驱动挂载函数的声明.

![截图 2024-05-12 17-34-35](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-34-35.png)

所以, 为了进一步获取更多的设备信息, 我们需要进入probe函数之中进行查找.

![截图 2024-05-12 17-34-52](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-34-52.png)

在这个函数里面, 我们可以查看到需要配置的各个参数

**由函数 of_property_read 进行指定与取值**

我们必须要保证设备树里面的参数与函数里的参数同名, 否则会无法读取到

![截图 2024-05-12 17-35-29](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-35-29.png)

![截图 2024-05-12 17-35-53](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-35-53.png)

![截图 2024-05-12 17-36-02](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-36-02.png)

**从上述图片可以看到, 我们需要指定的参数主要是**

(1)`tp-size`

(2)`touch-gpio`、`reset-gpio`、`power-gpio`

(3)`max-x`、`max-y`

其中 tp-size用于指定触摸IC的index参数, 来定义不同的外设信息. 要定义为 911, 89, 101等值, 从下面的if函数中可以看到.

​	xx-gpio用于指定芯片的GPIO外设对应的端口

​	max-x, y用于指定屏幕的大小参数

![截图 2024-05-12 17-37-03](E:/Typora_note/photos/%E6%88%AA%E5%9B%BE%202024-05-12%2017-37-03.png)

最终配置完毕之后, 设备树i2c-4部分如上所示



## 重新编译内核

这里不需要编译整个系统, 仅需编译内核即可.

比如在这里, 我们只修改了设备树, 所以编译指令如下

``` bash
./build.sh kernel && ./build.sh frimware
```

./build.sh kernel : 编译内核

./build.sh frimware : 打包成img文件



​	在上图可以看到, 编译时有报错, 这是因为给出的SDK中的makefile文件是有问题的, 我们需要手动在sysdrv部分的makefile顶部指定一个全局变量, 来声明我们使用的deconfig配置文件是哪个.

![](E:/Typora_note/photos/QQ%E5%9B%BE%E7%89%8720240514171418.png)

再进行编译则不会报错.



## 烧录内核

在烧录内核时, 我们不需要烧写其他img文件, 仅需勾选env文件与boot文件, 进行替换烧写.

![image-20240514171622687](E:/Typora_note/photos/image-20240514171622687.png)

烧写后启动, 便可以看到设备树里面添加了4-005d节点.

此时GT911驱动便被成功编译进了设备树之中.

![](E:/Typora_note/photos/QQ%E5%9B%BE%E7%89%8720240514165731-1715678277157-16.jpg)



## 驱动问题

如果直接替换内核, 那么内核版本会被更新, 导致原有的wifi驱动无法加载

此时仅需重新编译一遍wifi驱动部分, 然后将新编译出的ko文件传输过去, 即可适配新内核